<?php
require_once __DIR__ . '/session_bootstrap.php';
require_once __DIR__ . '/config.php';
// PHPMailer availability (used for OTP emails)
if (file_exists(__DIR__ . '/vendor/autoload.php')) {
	require_once __DIR__ . '/vendor/autoload.php';
} else {
	require __DIR__ . '/PHPMailer/src/Exception.php';
	require __DIR__ . '/PHPMailer/src/PHPMailer.php';
	require __DIR__ . '/PHPMailer/src/SMTP.php';
}

$message = '';
$messageType = '';
$otpSent = false;

// Require login
// Require authenticated session and only allow editing own account
$accountID = isset($_SESSION['accountID']) ? intval($_SESSION['accountID']) : 0;
if (empty($accountID)) {
	header('Location: index.php');
	exit();
}
// If a different accountID is supplied via GET, ignore it to prevent editing others' accounts

// Fetch current user
$stmt = $conn->prepare('SELECT username, email, passwordHash FROM vendoraccount WHERE accountID = ? LIMIT 1');
$stmt->bind_param('i', $accountID);
$stmt->execute();
$result = $stmt->get_result();
if ($result && $row = $result->fetch_assoc()) {
	$currentUsername = $row['username'];
	$currentEmail = $row['email'];
	$currentHash = $row['passwordHash'];
} else {
	$message = 'Account not found.';
	$messageType = 'error';
	$currentUsername = '';
	$currentEmail = '';
	$currentHash = '';
}

// Home link depending on role
$homeLink = (isset($_SESSION['role']) && $_SESSION['role'] === 'vendor') ? 'VendorHomepage.php' : 'AdminHome.php';

// OTP pending state
$otpPending = isset($_SESSION['otp_pending']) && is_array($_SESSION['otp_pending']);

// Handle POST update
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
	// If verifying OTP
	if (!empty($_POST['otp_code'])) {
		$submittedOtp = trim($_POST['otp_code']);
		if (empty($_SESSION['otp_pending']) || !is_array($_SESSION['otp_pending'])) {
			$message = 'No OTP request pending. Please submit changes again.';
			$messageType = 'error';
		} else {
			$pending = &$_SESSION['otp_pending'];
			// check expiry
			if (time() > ($pending['expires'] ?? 0)) {
				unset($_SESSION['otp_pending']);
				$message = 'OTP expired. Please submit the password change again.';
				$messageType = 'error';
			} elseif (!empty($pending['attempts']) && $pending['attempts'] >= 5) {
				unset($_SESSION['otp_pending']);
				$message = 'Too many incorrect attempts. Please submit the password change again.';
				$messageType = 'error';
			} elseif (password_verify($submittedOtp, $pending['code_hash'])) {
				// OTP correct ‚Äî apply pending updates
				$fields = [];
				$params = [];
				$types = '';
				if (!empty($pending['newUsername']) && $pending['newUsername'] !== $currentUsername) {
					$fields[] = 'username = ?'; $params[] = $pending['newUsername']; $types .= 's';
				}
				if (!empty($pending['newEmail']) && $pending['newEmail'] !== $currentEmail) {
					$fields[] = 'email = ?'; $params[] = $pending['newEmail']; $types .= 's';
				}
				if (!empty($pending['newHash'])) {
					$fields[] = 'passwordHash = ?'; $params[] = $pending['newHash']; $types .= 's';
				}
				if (!empty($fields)) {
					$types .= 'i'; $params[] = $accountID;
					$sql = 'UPDATE vendoraccount SET ' . implode(', ', $fields) . ' WHERE accountID = ? LIMIT 1';
					$upd = $conn->prepare($sql);
					$bindParams = [];
					$bindParams[] = $types;
					foreach ($params as $k => $v) $bindParams[] = &$params[$k];
					call_user_func_array([$upd, 'bind_param'], $bindParams);
					if ($upd->execute()) {
						$message = 'Account updated successfully.';
						$messageType = 'success';
						if (!empty($pending['newUsername'])) { $_SESSION['username'] = $pending['newUsername']; $currentUsername = $pending['newUsername']; }
						if (!empty($pending['newEmail'])) { $currentEmail = $pending['newEmail']; }
						if (!empty($pending['newHash'])) { $currentHash = $pending['newHash']; }
					} else {
								$message = 'Failed to update account. Please try again.';
								$messageType = 'error';
					}
					$upd->close();
				} else {
					$message = 'No pending changes to apply.';
					$messageType = 'info';
				}
				unset($_SESSION['otp_pending']);
			} else {
				// incorrect
				$pending['attempts'] = ($pending['attempts'] ?? 0) + 1;
				$remaining = 5 - $pending['attempts'];
				if ($remaining <= 0) {
					unset($_SESSION['otp_pending']);
					$message = 'Too many incorrect attempts. Please submit the password change again.';
					$messageType = 'error';
				} else {
					$message = 'Incorrect OTP. Attempts remaining: ' . $remaining;
					$messageType = 'error';
					$otpSent = true; // keep OTP input visible
				}
			}
		}
	} else {
	$newUsername = array_key_exists('username', $_POST) ? trim($_POST['username']) : null;
	$newEmail = array_key_exists('email', $_POST) ? trim($_POST['email']) : null;
	$currentPassword = $_POST['current_password'] ?? '';
	$newPassword = array_key_exists('new_password', $_POST) ? $_POST['new_password'] : '';
	$confirmPassword = array_key_exists('confirm_password', $_POST) ? $_POST['confirm_password'] : '';

	// Validate only fields that were submitted
	if ($newUsername !== null && $newUsername === '') {
		$message = 'Username cannot be empty.';
		$messageType = 'error';
	} elseif ($newEmail !== null && ($newEmail === '' || !filter_var($newEmail, FILTER_VALIDATE_EMAIL))) {
		$message = 'Please provide a valid email address.';
		$messageType = 'error';
	} else {
		// If user wants to change password, verify current password and match new passwords
		$changingPassword = false;
		if ($newPassword !== '' || $confirmPassword !== '') {
			if ($newPassword !== $confirmPassword) {
				$message = 'New passwords do not match.';
				$messageType = 'error';
			} elseif (empty($currentPassword)) {
				$message = 'Please provide your current password to change to a new password.';
				$messageType = 'error';
			} elseif (!password_verify($currentPassword, $currentHash)) {
				$message = 'Current password is incorrect.';
				$messageType = 'error';
			} else {
				$changingPassword = true;
			}
		}

		if ($messageType !== 'error') {
			// Note: duplicate email allowed for now; skip uniqueness check
			if ($messageType === 'error') {
				// stop further processing when email check failed
			} else {

				// Build update query
				$fields = [];
				$params = [];
				$types = '';

				if ($newUsername !== null && $newUsername !== $currentUsername) {
					$fields[] = 'username = ?';
					$params[] = $newUsername;
					$types .= 's';
				}
				if ($newEmail !== null && $newEmail !== $currentEmail) {
					$fields[] = 'email = ?';
					$params[] = $newEmail;
					$types .= 's';
				}
				if ($changingPassword) {
					// Prepare new hash but do NOT persist yet ‚Äî require OTP verification
					$newHash = password_hash($newPassword, PASSWORD_DEFAULT);
					// Generate OTP and email it to the user's current email
					$otp = strval(random_int(100000, 999999));
					$otpHash = password_hash($otp, PASSWORD_DEFAULT);
					$expiry = time() + 600; // 10 minutes
					// store pending changes in session
					$_SESSION['otp_pending'] = [
						'code_hash' => $otpHash,
						'expires' => $expiry,
						'newHash' => $newHash,
						'newUsername' => $newUsername,
						'newEmail' => $newEmail,
						'attempts' => 0,
					];
					// send email
					try {
						$mail = new PHPMailer\PHPMailer\PHPMailer(true);
						$mail->isSMTP();
						$mail->Host = MAIL_HOST;
						$mail->SMTPAuth = true;
						$mail->Username = MAIL_USER;
						$mail->Password = MAIL_PASS;
						$mail->SMTPSecure = MAIL_ENCRYPTION;
						$mail->Port = MAIL_PORT;
						$mail->setFrom(MAIL_USER, 'Vendor System');
						$mail->addAddress($currentEmail);
						$mail->isHTML(true);
						$mail->Subject = 'Your OTP for password change';
						$mail->Body = "<p>Your OTP for changing your password is: <strong>" . htmlspecialchars($otp) . "</strong></p><p>This code expires in 10 minutes.</p>";
						$mail->send();
						$message = 'An OTP has been sent to your registered email. Enter it below to confirm the password change.';
						$messageType = 'info';
						$otpSent = true;
					} catch (\Exception $e) {
						$message = 'Failed to send OTP email. Please try again later.';
						$messageType = 'error';
						unset($_SESSION['otp_pending']);
					}
					// do not proceed with DB update now
				}

				if (!empty($fields)) {
					$types .= 'i'; // accountID
					$params[] = $accountID;
					$sql = 'UPDATE vendoraccount SET ' . implode(', ', $fields) . ' WHERE accountID = ? LIMIT 1';
					$upd = $conn->prepare($sql);
					// bind parameters dynamically
					$bindParams = [];
					$bindParams[] = $types;
					foreach ($params as $k => $v) $bindParams[] = &$params[$k];
					call_user_func_array([$upd, 'bind_param'], $bindParams);
					if ($upd->execute()) {
						$message = 'Account updated successfully.';
						$messageType = 'success';
						// Refresh current values and session username
						if (in_array('username = ?', $fields, true) || in_array('username = ?', $fields)) {
							$_SESSION['username'] = $newUsername;
							$currentUsername = $newUsername;
						}
						if (in_array('email = ?', $fields, true) || in_array('email = ?', $fields)) {
							$currentEmail = $newEmail;
						}
						if ($changingPassword) {
							$currentHash = $newHash;
						}
					} else {
						$message = 'Failed to update account. Please try again.';
						$messageType = 'error';
					}
					$upd->close();
				} else {
					$message = 'No changes detected.';
					$messageType = 'info';
				}
			}

		}


	}


}

}

	?>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Account Settings</title>
	<style>
		body { font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; margin:0; padding:40px; }
		.card { background:#fff; max-width:560px; margin:0 auto; padding:24px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.06); }
		.card h2 { margin:0 0 16px 0; }
		.form-group { margin-bottom:12px; }
		input[type=text], input[type=email], input[type=password] { width:100%; padding:10px; box-sizing:border-box; border:1px solid #d1d5db; border-radius:6px; }
		button { background:#2563eb; color:#fff; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; }
		.message { padding:10px; border-radius:6px; margin-bottom:12px; }
		.success { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
		.error { background:#fff1f2; color:#991b1b; border:1px solid #fecaca; }
		.info { background:#f0f9ff; color:#075985; border:1px solid #a5f3fc; }
	</style>
</head>
<body>
	<div class="card">
		<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
			<h2 style="margin:0;">Account Settings</h2>
			<div>
				<a href="<?php echo htmlspecialchars($homeLink); ?>" style="display:inline-block;margin-right:8px;text-decoration:none;background:#6b7280;color:#fff;padding:8px 10px;border-radius:6px;">Back</a>
			</div>
		</div>
		<?php if ($message): ?>
			<div class="message <?php echo htmlspecialchars($messageType); ?>"><?php echo htmlspecialchars($message); ?></div>
		<?php endif; ?>

		<form method="post" autocomplete="off" id="accountForm">
			<div class="form-group" style="display:flex;align-items:center;gap:8px;">
				<div style="flex:1;">
					<label>Username</label>
					<input type="text" name="username" value="<?php echo htmlspecialchars($currentUsername); ?>" required disabled>
				</div>
				<div style="white-space:nowrap;">
					<button type="button" class="field-edit" data-field="username" style="background:#f59e0b;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;">Edit</button>
					<button type="button" class="field-save" data-field="username" style="display:none;background:#16a34a;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;margin-left:6px;">Save</button>
					<button type="button" class="field-cancel" data-field="username" style="display:none;background:#ef4444;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;margin-left:6px;">Cancel</button>
				</div>
			</div>
			<div class="form-group" style="display:flex;align-items:center;gap:8px;">
				<div style="flex:1;">
					<label>Email</label>
					<input type="email" name="email" value="<?php echo htmlspecialchars($currentEmail); ?>" required disabled>
				</div>
				<div style="white-space:nowrap;">
					<button type="button" class="field-edit" data-field="email" style="background:#f59e0b;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;">Edit</button>
					<button type="button" class="field-save" data-field="email" style="display:none;background:#16a34a;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;margin-left:6px;">Save</button>
					<button type="button" class="field-cancel" data-field="email" style="display:none;background:#ef4444;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;margin-left:6px;">Cancel</button>
				</div>
			</div>

				<!-- Password edit control (button stays visible even when inputs are hidden) -->
				<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
					<div style="display:flex;align-items:center;gap:12px;">
						<p style="margin:0 0 8px 0;font-size:90%;color:#374151">Password</p>
						<div id="maskedPassword" style="font-family:monospace;letter-spacing:2px;color:#111827;background:#f8fafc;padding:6px 10px;border-radius:6px;border:1px solid #e5e7eb;">********</div>
						<div style="font-size:90%;color:#6b7280;margin-left:6px;">(hidden)</div>
					</div>
					<div style="white-space:nowrap;">
						<button type="button" id="editPassword" style="background:#f59e0b;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;">Edit Password</button>
						<button type="button" id="savePassword" style="display:none;background:#16a34a;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;margin-left:6px;">Request OTP</button>
						<button type="button" id="cancelPassword" style="display:none;background:#ef4444;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;margin-left:6px;">Cancel</button>
					</div>
				</div>
				<div id="passwordSection" style="display:flex;flex-direction:column;">
					<hr style="margin:16px 0;">
					<div style="display:flex;align-items:center;gap:8px;">
						<div style="flex:1;">
							<div class="form-group">
								<label>Current Password</label>
								<input type="password" name="current_password" placeholder="Enter current password" disabled>
							</div>
						</div>
					</div>

				<?php if ($otpPending || $otpSent): ?>
					<div id="otpSection" style="margin-top:12px;">
						<hr style="margin:16px 0;">
						<p style="margin:0 0 8px 0;font-size:90%;color:#374151">Enter OTP sent to your email</p>
						<div class="form-group">
							<label>OTP Code</label>
							<input type="text" name="otp_code" placeholder="6-digit code" required>
						</div>
					</div>
				<?php endif; ?>
				<div id="newPasswordFields" style="display:none;">
					<div class="form-group" style="position:relative;">
						<label>New Password</label>
						<input type="password" name="new_password" id="new_password" placeholder="New password" disabled style="padding-right:45px;">
						<button type="button" id="toggleNewPassword" tabindex="-1" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);margin-top:10px;background:none;border:none;cursor:pointer;color:#666;font-size:18px;padding:5px;width:auto;height:auto;line-height:1;">üëÅÔ∏è</button>
					</div>
					<div id="passwordHelp" style="font-size:13px;color:#666;margin-bottom:8px;">Must be at least 8 characters, include upper/lowercase, number, and symbol.</div>
					<div id="strengthFeedback" style="font-size:13px;color:#d32f2f;margin-bottom:10px;"></div>
					<div class="form-group">
						<label>Confirm New Password</label>
						<input type="password" name="confirm_password" placeholder="Confirm new password" disabled>
					</div>
				</div>
			</div>
			<div style="text-align:right;margin-top:8px;">
				<!-- save/cancel buttons are at top; show note when form is disabled -->
				<small id="noteText" style="color:#475569;">Click "Edit" to modify your account information.</small>
			</div>
		</form>
		<script>
			(function(){
				// global edit buttons removed; per-field controls used instead
				const form = document.getElementById('accountForm');
				const inputs = form.querySelectorAll('input[name=username], input[name=email]');
				const passwordSection = document.getElementById('passwordSection');
				const note = document.getElementById('noteText');

				// store originals
				const original = {
					username: form.querySelector('input[name=username]').value,
					email: form.querySelector('input[name=email]').value
				};

				function enterEdit() {
					inputs.forEach(i=>{ i.disabled = false; });
					passwordSection.style.display = 'block';
					if (note) note.style.display = 'none';
				}

				function exitEdit(restore=true) {
								if (verifyBtn) {
									verifyBtn.addEventListener('click', function(ev){
										ev.preventDefault();
										var code = otpSection.querySelector('input[name=otp_code]').value;
										// UX: disable button and show verifying state
										verifyBtn.disabled = true;
										var originalText = verifyBtn.textContent;
										verifyBtn.textContent = 'Verifying...';
										fetch('APIManageAccount.php', {
											method: 'POST',
											credentials: 'same-origin',
											headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
											body: new URLSearchParams({ action: 'verify_otp', otp_code: code })
										}).then(r => r.json()).then(function(j){
											var m = document.getElementById('ajaxMessage'); if (!m) { m = document.createElement('div'); m.id='ajaxMessage'; m.style.marginBottom='12px'; form.parentNode.insertBefore(m, form);} 
											m.textContent = j.message || (j.success? 'Verified' : 'Error'); m.className = j.success? 'message success' : 'message error';
											if (j.success) {
												// allow user to enter new password now
												if (otpSection && otpSection.parentNode) otpSection.parentNode.removeChild(otpSection);
												var npf = document.getElementById('newPasswordFields'); if (npf) npf.style.display = 'block';
												var newPasswordInput = form.querySelector('input[name=new_password]');
												var confPasswordInput = form.querySelector('input[name=confirm_password]');
												if (newPasswordInput) { newPasswordInput.disabled = false; newPasswordInput.focus(); }
												if (confPasswordInput) confPasswordInput.disabled = false;
												// switch save button to 'set' mode
												savePassword.dataset.mode = 'set';
												savePassword.textContent = 'Set New Password';
												// enable inputs for new password
												newPwd.disabled = false; confPwd.disabled = false;
											} else {
												// on failure, re-enable verify button
												verifyBtn.disabled = false;
												verifyBtn.textContent = originalText;
											}
										}).catch(function(){
											alert('Request failed');
											verifyBtn.disabled = false;
											verifyBtn.textContent = originalText;
										});
									});
								}
					btn.addEventListener('click', function(e){
						var field = btn.getAttribute('data-field');
						var input = form.querySelector('input[name="' + field + '"]');
						if (!input) return;
						// show save/cancel for this field
						form.querySelectorAll('.field-save[data-field="' + field + '"]')[0].style.display = '';
						form.querySelectorAll('.field-cancel[data-field="' + field + '"]')[0].style.display = '';
						btn.style.display = 'none';
						input.disabled = false;
						input.focus();
					});
				});

				document.querySelectorAll('.field-cancel').forEach(function(btn){
					btn.addEventListener('click', function(e){
						var field = btn.getAttribute('data-field');
						var input = form.querySelector('input[name="' + field + '"]');
						if (!input) return;
						// restore original
						input.value = original[field];
						input.disabled = true;
						btn.style.display = 'none';
						form.querySelectorAll('.field-save[data-field="' + field + '"]')[0].style.display = 'none';
						form.querySelectorAll('.field-edit[data-field="' + field + '"]')[0].style.display = '';
					});
				});

				document.querySelectorAll('.field-save').forEach(function(btn){
					btn.addEventListener('click', function(e){
						e.preventDefault();
						var field = btn.getAttribute('data-field');
						var input = form.querySelector('input[name="' + field + '"]');
						if (!input) return;
						var value = input.value;
						// send AJAX request to save this field
						fetch('APIManageAccount.php', {
							method: 'POST',
							credentials: 'same-origin',
							headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
							body: new URLSearchParams({ action: 'save_field', field: field, value: value })
						}).then(r => r.json()).then(function(json){
							var msgEl = document.getElementById('ajaxMessage');
							if (!msgEl) {
								msgEl = document.createElement('div'); msgEl.id = 'ajaxMessage'; msgEl.style.marginBottom = '12px'; form.parentNode.insertBefore(msgEl, form);
							}
							msgEl.textContent = json.message || (json.success ? 'Saved' : 'Error');
							msgEl.className = json.success ? 'message success' : 'message error';
							if (json.success) {
								// hide save/cancel for this field
								input.disabled = true;
								form.querySelectorAll('.field-save[data-field="' + field + '"]')[0].style.display = 'none';
								form.querySelectorAll('.field-cancel[data-field="' + field + '"]')[0].style.display = 'none';
								form.querySelectorAll('.field-edit[data-field="' + field + '"]')[0].style.display = '';
							}
						}).catch(function(){ alert('Request failed'); });
					});
				});

				// Password-specific controls
				var editPassword = document.getElementById('editPassword');
				var savePassword = document.getElementById('savePassword');
				var cancelPassword = document.getElementById('cancelPassword');
				var curPwd = form.querySelector('input[name=current_password]');
				var newPwd = form.querySelector('input[name=new_password]');
				var confPwd = form.querySelector('input[name=confirm_password]');
				if (editPassword) {
					editPassword.addEventListener('click', function(e){
						e.preventDefault();
						// reveal password section for entering current password
						passwordSection.style.display = 'block';
						// hide masked display while editing
						var mp = document.getElementById('maskedPassword'); if (mp) mp.style.display = 'none';
						editPassword.style.display = 'none';
						savePassword.style.display = '';
						cancelPassword.style.display = '';
						// ensure request mode
						savePassword.dataset.mode = 'request';
						savePassword.textContent = 'Request OTP';
						curPwd.disabled = false; newPwd.disabled = true; confPwd.disabled = true;
						curPwd.focus();
					});
				}
				if (cancelPassword) {
					cancelPassword.addEventListener('click', function(e){
						e.preventDefault();
						editPassword.style.display = '';
						savePassword.style.display = 'none';
						cancelPassword.style.display = 'none';
									// hide new password fields after saving/cancelling
									var npf = document.getElementById('newPasswordFields'); if (npf) npf.style.display = 'none';
						curPwd.value = ''; newPwd.value = ''; confPwd.value = '';
						curPwd.disabled = true; newPwd.disabled = true; confPwd.disabled = true;
						// hide password section again when cancelling
						passwordSection.style.display = 'none';
						// restore masked display
						var mp = document.getElementById('maskedPassword'); if (mp) mp.style.display = '';
					});
				}
				if (savePassword) {
					// start in 'request' mode: request OTP using current password
					savePassword.dataset.mode = 'request';
					savePassword.textContent = 'Request OTP';
					savePassword.addEventListener('click', function(e){
						e.preventDefault();
						var mode = savePassword.dataset.mode || 'request';
						if (mode === 'set') {
							// set new password after OTP verified
							var nw = form.querySelector('input[name=new_password]').value;
							var cf = form.querySelector('input[name=confirm_password]').value;
							fetch('APIManageAccount.php', {
								method: 'POST',
								credentials: 'same-origin',
								headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
								body: new URLSearchParams({ action: 'set_new_password', new_password: nw, confirm_password: cf })
							}).then(r => r.json()).then(function(json){
								var msgEl = document.getElementById('ajaxMessage');
								if (!msgEl) { msgEl = document.createElement('div'); msgEl.id = 'ajaxMessage'; msgEl.style.marginBottom = '12px'; form.parentNode.insertBefore(msgEl, form); }
								msgEl.textContent = json.message || (json.success ? 'Password set' : 'Error');
								msgEl.className = json.success ? 'message success' : 'message error';
								if (json.success) {
									// reset UI
									form.querySelector('input[name=current_password]').value = '';
									form.querySelector('input[name=new_password]').value = '';
									form.querySelector('input[name=confirm_password]').value = '';
									form.querySelector('input[name=new_password]').disabled = true;
									form.querySelector('input[name=confirm_password]').disabled = true;
									savePassword.dataset.mode = 'request';
									savePassword.textContent = 'Request OTP';
									editPassword.style.display = '';
									savePassword.style.display = 'none';
									cancelPassword.style.display = 'none';
									// restore masked display
									var mp = document.getElementById('maskedPassword'); if (mp) mp.style.display = '';
								}
							}).catch(function(){ alert('Request failed'); });
							return;
						}

						// request OTP
						var cur = form.querySelector('input[name=current_password]').value;
						fetch('APIManageAccount.php', {
							method: 'POST',
							credentials: 'same-origin',
							headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
							body: new URLSearchParams({ action: 'initiate_password_change', current_password: cur })
						}).then(r => r.json()).then(function(json){
							var msgEl = document.getElementById('ajaxMessage');
							if (!msgEl) { msgEl = document.createElement('div'); msgEl.id = 'ajaxMessage'; msgEl.style.marginBottom = '12px'; form.parentNode.insertBefore(msgEl, form); }
							msgEl.textContent = json.message || (json.success ? 'OTP sent' : 'Error');
							msgEl.className = json.success ? 'message info' : 'message error';
							if (json.success) {
								// show OTP input and verify button
								var otpSection = document.getElementById('otpSection');
								if (!otpSection) {
									otpSection = document.createElement('div'); otpSection.id = 'otpSection'; otpSection.style.marginTop = '12px';
									otpSection.innerHTML = '<hr style="margin:16px 0;"><p style="margin:0 0 8px 0;font-size:90%;color:#374151">Enter OTP sent to your email</p><div class="form-group"><label>OTP Code</label><input type="text" name="otp_code" placeholder="6-digit code"></div><div style="text-align:right;"><button id="verifyOtpBtn" style="background:#059669;color:#fff;padding:8px 10px;border-radius:6px;border:none;">Verify OTP</button></div>';
									passwordSection.parentNode.insertBefore(otpSection, passwordSection.nextSibling);
								}
								var verifyBtn = document.getElementById('verifyOtpBtn');
								if (verifyBtn) {
									verifyBtn.addEventListener('click', function(ev){
										ev.preventDefault();
										var code = otpSection.querySelector('input[name=otp_code]').value;
										fetch('APIManageAccount.php', {
											method: 'POST',
											credentials: 'same-origin',
											headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
											body: new URLSearchParams({ action: 'verify_otp', otp_code: code })
										}).then(r => r.json()).then(function(j){
											var m = document.getElementById('ajaxMessage'); if (!m) { m = document.createElement('div'); m.id='ajaxMessage'; m.style.marginBottom='12px'; form.parentNode.insertBefore(m, form);} 
											m.textContent = j.message || (j.success? 'Verified' : 'Error'); m.className = j.success? 'message success' : 'message error';
													if (j.success) {
																	// allow user to enter new password now
																	if (otpSection && otpSection.parentNode) otpSection.parentNode.removeChild(otpSection);
																	var npf = document.getElementById('newPasswordFields');
																	if (npf) npf.style.display = 'block';
																	form.querySelector('input[name=new_password]').disabled = false;
																	form.querySelector('input[name=confirm_password]').disabled = false;
																	// switch save button to 'set' mode
																	savePassword.dataset.mode = 'set';
																	savePassword.textContent = 'Set New Password';
																	// enable inputs for new password
																	newPwd.disabled = false; confPwd.disabled = false;
																}
										}).catch(function(){ alert('Request failed'); });
									});
								}
							}
						}).catch(function(){ alert('Request failed'); });
					});
				}

				// Initialize per-field as view-only
				exitEdit(false);
			})();
		</script>
			<?php if ($otpPending || $otpSent): ?>
			<script>
				// Open password edit mode and focus OTP when server sent OTP
				(function(){
					var pwdBtn = document.getElementById('editPassword');
					if (pwdBtn) pwdBtn.click();
					var otp = document.querySelector('input[name=otp_code]');
					if (otp) otp.focus();
				})();
			</script>
			<?php endif; ?>
	</div>
</body>
</html>